<brn-sheet #sheet="brnSheet">
  <ng-container *ngIf="petDetail">
    <hlm-sheet [side]="isMobile ? 'bottom' : 'right'">
      <button hlmBtn brnSheetTrigger asChild style="display: none;" #hiddenTrigger></button>

      <!-- Conteúdo do sheet -->
      <hlm-sheet-content *brnSheetContent="let ctx" class="p-0">
        <hlm-sheet-header class="w-full">
          <img *ngIf="petDetail.petImage" [src]="petDetail.petImage" class="w-full h-full mx-auto object-cover" />
        </hlm-sheet-header>

        <div class="p-4 space-y-2 flex flex-col items-start">
          <div class="flex justify-start items-center">
            <h2 hlmSheetTitle class="text-2xl">{{ petDetail.apelido }}</h2>
          </div>
          <div class="flex justify-start items-center">
            <spartan-icon iconName="lucideMapPin" iconSize="sm"></spartan-icon>
            <p hlmSheetDescription class="ml-2 truncate max-w-[300px]" [title]="petDetail.localizacao">{{
              petDetail.localizacao }}</p>
          </div>
          <div class="flex justify-start items-start">
            <spartan-icon iconName="lucideScrollText" iconSize="sm"></spartan-icon>
            <p hlmSheetDescription class="ml-2 break-words text-left">
              {{ petDetail.descricao }}
            </p>
          </div>
          <div class="flex justify-start items-center">
            <spartan-icon iconName="lucideMap" iconSize="sm"></spartan-icon>
            <p hlmSheetDescription class="ml-2">{{ petDetail.lat }}, {{ petDetail.lng }}</p>
          </div>
          <div class="flex justify-start items-center">
            <spartan-icon iconName="lucideCheck" iconSize="sm" *ngIf="petDetail.coleira"></spartan-icon>
            <spartan-icon iconName="lucideX" iconSize="sm" *ngIf="!petDetail.coleira"></spartan-icon>
            <p hlmSheetDescription class="ml-2">{{ petDetail.coleira ?
              'Possui coleira' :
              'Não possui coleira' }}
            </p>
          </div>

          <div class="flex justify-start items-center">
            <img [src]="petDetail.user?.photoURL" alt="Foto de perfil" class="w-6 h-6 rounded-full border" />
            <p hlmSheetDescription class="ml-2">Enviado por {{ petDetail.user?.displayName || 'Usuário desconhecido' }}
            </p>
          </div>

          <!-- Comentários -->
          <div class="w-full flex flex-col items-start">
            <h1 class="font-bold mb-2">Discussão</h1>

            <div *ngFor="let comment of comments"
              class="flex flex-col rounded-sm p-2 w-full gap-2 mb-2 justify-between">
              <div class="flex justify-between items-center gap-2">

                <div class="flex items-start gap-2">
                  <div class="w-10 h-10 rounded-full bg-slate-300 overflow-hidden">
                    <img *ngIf="comment.user?.photoURL" [src]="comment.user.photoURL" />
                  </div>

                  <div class="flex flex-col justify-start items-start">
                    <div class="flex items-center gap-2">
                      <p class="text-sm font-bold">{{ comment.user?.displayName || 'Usuário desconhecido' }}</p>
                      <span class="text-xs text-gray-400">{{ getTimeSinceCreation(comment.createdAt) }}</span>
                    </div>
                    <p class="text-sm text-gray-500">{{ comment.text }}</p>
                  </div>
                </div>

                <div class="flex justify-end items-center gap-2">
                  <button *ngIf="comment.userId === currentUserId" hlmBtn
                    class="w-6 h-6 flex justify-center items-center border p-2 rounded-sm" variant="outline">
                    <spartan-icon iconName="lucidePencil" iconSize="sm"
                      class="flex items-center justify-center"></spartan-icon>
                  </button>
                  <button hlmBtn class="w-6 h-6 flex justify-center items-center border p-2 rounded-sm"
                    variant="outline">
                    <spartan-icon iconName="lucideReply" iconSize="sm"
                      class="flex items-center justify-center" (click)="replyTo(comment)"></spartan-icon>
                  </button>
                </div>
              </div>

              <!-- Contagem de respostas -->
              <div *ngIf="replyCounts[comment.id] > 0" (click)="toggleReplies(comment.id)"
                class="flex items-center gap-4 cursor-pointer hover:opacity-80 transition">
                <div class="flex-1 border-t border-gray-300"></div>
                <span class="text-sm text-gray-500 whitespace-nowrap">
                  {{ showReplies[comment.id] ? 'Ocultar' : 'Exibir' }} {{ replyCounts[comment.id] }} resposta{{
                  replyCounts[comment.id] > 1 ? 's' : '' }}
                </span>
                <div class="flex-1 border-t border-gray-300"></div>
              </div>

              <!-- Respostas -->

              <div *ngIf="showReplies[comment.id]">
                <div *ngFor="let reply of replies[comment.id]" class="flex items-start gap-2 ml-12 mb-2">
                  <div class="w-6 h-6 rounded-full bg-slate-300 overflow-hidden">
                    <img *ngIf="reply.user?.photoURL" [src]="reply.user.photoURL" />
                  </div>

                  <div class="w-full flex flex-col justify-start items-start">
                    <div class="flex justify-start items-start gap-1">
                      <p class="text-xs font-bold">
                        {{ reply.user?.displayName || 'Usuário desconhecido' }}
                      </p>
                      <span *ngIf="reply.parentId && reply.parentId !== comment.id"
                        class="text-xs text-gray-400 flex justify-start items-start gap-1">
                        <spartan-icon iconName="lucideReply" iconSize="xs"
                          class="flex items-center justify-center" (click)="replyTo(comment)"></spartan-icon>
                        {{ reply.repliedToName }}
                      </span>
                    </div>
                    <p class="text-sm text-gray-500">{{ reply.text }}</p>

                    <!-- Ações da resposta -->
                    <div class="flex justify-start items-center w-full mt-1">
                      <span class="text-xs text-gray-400">{{ getTimeSinceCreation(reply.createdAt) }}</span>

                      <div class="flex justify-end items-center gap-2 ml-2">
                        <button *ngIf="comment.userId === currentUserId" hlmBtn
                          class="w-2 h-2 flex justify-center items-center border p-2 rounded-sm" variant="outline">
                          <spartan-icon iconName="lucidePencil" iconSize="xs"
                            class="flex items-center justify-center"></spartan-icon>
                        </button>
                        <button hlmBtn class="w-2 h-2 flex justify-center items-center border p-2 rounded-sm"
                          variant="outline">
                          <spartan-icon iconName="lucideReply" iconSize="xs"
                            class="flex items-center justify-center" (click)="replyTo(comment)"></spartan-icon>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <hlm-sheet-footer class="fixed bottom-0 w-96 p-2 bg-white border-t">
          <div class="w-full flex flex-col items-end">
            <textarea hlmInput placeholder="Deixe seu comentário..." class="min-h-[40px] w-full border p-2 rounded-sm"
              [(ngModel)]="newCommentText"></textarea>

            <div class="flex justify-between items-center w-full mt-2">
              <span class="text-sm text-gray-500" *ngIf="replyingToName">
                Em resposta a <strong>{{ replyingToName }}</strong>
                <button class="ml-2 text-xs text-red-500 underline" (click)="cancelReply()">Cancelar</button>
              </span>
              <button hlmBtn class="mt-2 bg-[#159A9C]" (click)="submitComment()"
                [disabled]="!newCommentText.trim()">Enviar</button>
            </div>
          </div>
        </hlm-sheet-footer>
      </hlm-sheet-content>
    </hlm-sheet>
  </ng-container>
</brn-sheet>


<div class="map-container">
  <div class="map-frame">
    <div id="map"></div>
  </div>
</div>